name: Build Desktop Packages

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Test build without creating release"
        required: false
        default: true
        type: boolean
      platforms:
        description: "Platforms to build"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - macos
          - windows
          - linux
      release_tag:
        description: "Tag to create/use for release (e.g. v1.0.6). Required when dry_run=false"
        required: false
        default: ""
        type: string

jobs:
  build-macos:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' }}
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build backend binary
        run: |
          pip install -r backend/requirements.txt
          pyinstaller backend/backend.spec --distpath backend/dist --clean -y

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Vite app
        run: npm run build

      - name: Package macOS
        run: npx electron-builder --mac --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            release/*.dmg
            release/*.zip
            release/*.yml
            release/*.blockmap
          retention-days: 30

  build-windows:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' }}
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build backend binary
        run: |
          pip install -r backend/requirements.txt
          pyinstaller backend/backend.spec --distpath backend/dist --clean -y

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Vite app
        run: npm run build

      - name: Package Windows
        run: npx electron-builder --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            release/*.exe
            release/*.yml
            release/*.blockmap
          retention-days: 30

  build-linux:
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build backend binary
        run: |
          pip install -r backend/requirements.txt
          pyinstaller backend/backend.spec --distpath backend/dist --clean -y

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Vite app
        run: npm run build

      - name: Package Linux
        run: npx electron-builder --linux --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
            release/*.yml
            release/*.blockmap
          retention-days: 30

  create-release:
    needs: [build-macos, build-windows, build-linux]
    if: ${{ always() && github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate release_tag when publishing
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          if [ -z "${{ github.event.inputs.release_tag }}" ]; then
            echo "::error::release_tag is required when dry_run=false (e.g. v1.0.6)"
            exit 1
          fi

      - name: Check if any build succeeded
        run: |
          if [[ "${{ needs.build-macos.result }}" != "success" && \
                "${{ needs.build-windows.result }}" != "success" && \
                "${{ needs.build-linux.result }}" != "success" ]]; then
            echo "::error::All builds failed, cannot proceed"
            exit 1
          fi
          echo "At least one build succeeded, proceeding"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
        continue-on-error: true

      - name: Flatten and validate artifacts
        run: |
          mkdir -p release-assets
          find dist -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.yml" -o -name "*.blockmap" \) \
            -exec cp -n {} release-assets/ \; 2>/dev/null || true

          installer_count=$(find release-assets -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) 2>/dev/null | wc -l)

          echo "Found $installer_count installer(s)"
          echo ""
          echo "All release assets:"
          ls -la release-assets/ || echo "No assets found"

      - name: Generate checksums
        run: |
          cd release-assets
          if ls ./* 1> /dev/null 2>&1; then
            sha256sum ./* > checksums.sha256
            cat checksums.sha256
          else
            echo "No files to checksum"
          fi

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            VERSION="${{ github.event.inputs.release_tag }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build Summary (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "## Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release-assets/ >> $GITHUB_STEP_SUMMARY || echo "No assets" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Create Release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: Electron React FastAPI v${{ steps.version.outputs.version }}
          body: |
            ## Electron React FastAPI v${{ steps.version.outputs.version }}

            ### Downloads
            - **macOS (Apple Silicon)**: Download the ARM64 `.dmg` file
            - **macOS (Intel)**: Download the x64 `.dmg` file
            - **Windows**: Download the `.exe` installer
            - **Linux**: Download `.AppImage`, `.deb`, or `.rpm`

            ### Build Status
            | Platform | Status |
            |----------|--------|
            | macOS | ${{ needs.build-macos.result }} |
            | Windows | ${{ needs.build-windows.result }} |
            | Linux | ${{ needs.build-linux.result }} |

            ### Checksums
            See `checksums.sha256` for file verification.
          files: release-assets/*
          fail_on_unmatched_files: false
          draft: false
          prerelease: ${{ contains(github.event.inputs.release_tag, 'beta') || contains(github.event.inputs.release_tag, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
